import xml.etree.ElementTree as ElementTree
import sys            

cpuNameTable = {
    "CM0+": "cortex-m0plus",
    "CM0": "cortex-m0",
    "CM0PLUS": "cortex-mplus",
    "CM1": "cortex-m1",
    "CM3": "cortex-m3",
    "CM4": "cortex-m4"
}

for svd in sys.argv[1:]:
    tree = ElementTree.parse(svd)
    root = tree.getroot()
    deviceName = tree.find("name").text

    # create cmake file
    with open("{}.cmake".format(deviceName), 'w') as f:
        cpu = root.find("cpu")
        name = cpu.find("name").text
        endian = cpu.find("endian").text
        fpuPresent = cpu.find("fpuPresent").text
        
        f.write("set(CPU {})\n".format(cpuNameTable[name]))
        f.write("set(ENDIAN {})\n".format(endian))
        f.write("set(FLOAT_ABI {})\n".format(fpuPresent))

    # create header file
    with open("{}.hpp".format(deviceName), 'w') as f:
        print(deviceName)
        f.write("// This is a file generated by svd-alias.\n\n")
        f.write("#pragma once\n\n")
        f.write("#include \"svd-alias/bit-field.hpp\"\n")
        f.write("#include \"svd-alias/register.hpp\"\n\n")
        f.write('struct %s {\n' % deviceName)
        for peripheral in root.iter("peripheral"):
            peripheralName = peripheral.find("name").text
            baseAddress = int(peripheral.find("baseAddress").text, 16)
            print("\t{}: {}".format(peripheralName, hex(baseAddress)))
            if peripheral.attrib and peripheral.attrib["derivedFrom"]:
                for tmp in root.iter("peripheral"):
                    if peripheral.attrib["derivedFrom"] == tmp.find("name").text:
                        peripheral = tmp
                        break

            if peripheral.find("description") is not None:
                peripheralDescription = peripheral.find("description").text
                f.write('    // %s\n' % ' '.join(peripheralDescription.replace('\n', ' ').replace('\r', '').split()))
            
            f.write('    struct %s {\n' % peripheralName)
            for register in peripheral.iter("register"):
                registerName = register.find("name").text
                addressOffset = int(register.find("addressOffset").text, 16)
                if register.find("description") is not None:
                    registerDescription = register.find("description").text
                    f.write('        // %s\n' % ' '.join(registerDescription.replace('\n', ' ').replace('\r', '').split()))
                
                f.write('        struct %s : public Register<%s> {\n' % (registerName, hex(baseAddress + addressOffset)))
                for field in register.iter("field"):
                    fieldDescription = field.find("description");
                    fieldName = field.find("name").text
                    bitWidth = field.find("bitWidth").text
                    bitOffset = field.find("bitOffset").text
                    f.write('            using %s = Field<%s, %s>;' % (fieldName if fieldName != registerName else "Field", bitOffset, bitWidth))
                    if fieldDescription is not None:
                        f.write('    // %s' % ' '.join(fieldDescription.text.replace('\n', ' ').replace('\r', '').split()))
                    
                    f.write('\n')

                f.write('        };\n\n')

            f.write('    };\n\n')

        f.write('};\n')
